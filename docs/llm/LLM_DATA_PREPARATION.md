# LLM Module — Data Preparation Plan

How to transform SOM outputs into LLM-ready context.

---

## 1. Two Input Files

### 1.1 Dataset Context File (user-provided)

Location: `data/datasets/{DatasetName}/dataset_context.txt`

This file is written once per dataset by the user. It tells the LLM what the data means. Without this file, the LLM can only report numbers — it cannot interpret them.

**Template:**

```
DATASET: {name}
DOMAIN: {domain}
DESCRIPTION: {what this dataset contains}
SAMPLE: Each row represents {what}

COLUMNS:
- {column_name}: {description}. Unit: {unit}. Range: {min}-{max}.
  Meaning: {domain interpretation}
- ...

CATEGORIES:
- {column_name}: {value1} = {meaning}, {value2} = {meaning}
- ...

DOMAIN KNOWLEDGE:
- {any domain-specific insight the LLM should know}
- ...
```

**Example for BreastCancer:**

```
DATASET: Breast Cancer Wisconsin Diagnostic
DOMAIN: Medical / Oncology
DESCRIPTION: Features computed from digitized images of fine needle aspirate (FNA) of breast masses
SAMPLE: Each row represents one tumor biopsy sample

COLUMNS:
- id: Unique patient identifier. Not a measurement.
- diagnosis: Tumor classification. Categorical.
- radius_mean: Mean distance from center to perimeter of cell nuclei. Unit: μm.
  Meaning: Larger radius suggests larger, potentially malignant tumor cells.
- texture_mean: Standard deviation of gray-scale values in cell image. Unitless.
  Meaning: Higher texture indicates more irregular cell surface.
- perimeter_mean: Mean perimeter of cell nuclei. Unit: μm.
  Meaning: Correlates with radius — larger perimeter = larger cells.
- area_mean: Mean area of cell nuclei. Unit: μm².
  Meaning: Directly related to cell size. Malignant cells tend to be larger.
- smoothness_mean: Local variation in radius lengths. Unitless (0-1).
  Meaning: Lower = smoother boundary. Malignant cells often have irregular boundaries.
- compactness_mean: perimeter² / area - 1.0. Unitless.
  Meaning: Higher values indicate more irregular shape.
- concavity_mean: Severity of concave portions of cell contour. Unitless.
  Meaning: Higher concavity = more irregular, indented boundary.
- concave points_mean: Number of concave portions of contour. Unitless.
  Meaning: More concave points = more irregular shape.
- symmetry_mean: Symmetry of cell nuclei. Unitless.
  Meaning: Lower = more symmetric. Malignant cells are often asymmetric.
- fractal_dimension_mean: Coastline approximation - 1. Unitless.
  Meaning: Measures boundary complexity. Higher = more complex boundary.
- *_se: Standard error of the corresponding measurement across nuclei in the image.
- *_worst: Largest (worst) value of the corresponding measurement across nuclei.

CATEGORIES:
- diagnosis: B = Benign (non-cancerous), M = Malignant (cancerous)

DOMAIN KNOWLEDGE:
- Malignant tumors typically show larger radius, area, and perimeter
- Higher concavity and more concave points are strong indicators of malignancy
- The _worst features (largest values) are often more discriminative than _mean
- Benign tumors cluster tightly with lower metric values
- Some features are mathematically correlated (radius, perimeter, area)
```

---

### 1.2 SOM Analysis Summary (auto-generated)

Location: `{working_dir}/json/llm_context.json`

Generated by the Context Builder from existing SOM output files.

**Structure:**

```json
{
  "map": {
    "size": [5, 5],
    "topology": "hex",
    "total_samples": 569,
    "total_neurons": 25,
    "dead_neurons": 5,
    "dead_ratio": 0.20,
    "mqe": 0.569,
    "topographic_error": 0.12
  },

  "clusters": [
    {
      "neuron": "1_0",
      "sample_count": 242,
      "quantization_error": 0.45,
      "categories": { "diagnosis": { "B": 242, "M": 0 } },
      "dominant_category": { "diagnosis": "B" },
      "purity": 1.0,
      "dimension_means": {
        "radius_mean": 12.15,
        "texture_mean": 17.82,
        "area_mean": 420.3
      }
    },
    {
      "neuron": "0_4",
      "sample_count": 47,
      "quantization_error": 0.66,
      "categories": { "diagnosis": { "B": 0, "M": 47 } },
      "dominant_category": { "diagnosis": "M" },
      "purity": 1.0,
      "dimension_means": {
        "radius_mean": 18.53,
        "texture_mean": 21.44,
        "area_mean": 1050.7
      }
    }
  ],

  "anomalies": {
    "global_outlier_count": 5,
    "local_outlier_count": 12,
    "top_anomalies": [
      {
        "sample_id": "911296202",
        "neuron": "0_4",
        "reasons": [
          "area_mean=2501 is global maximum",
          "radius_worst=36.04 is global maximum",
          "13 dimensions exceed 2.5σ from global mean"
        ]
      }
    ]
  },

  "dimension_stats": {
    "radius_mean": { "min": 6.98, "max": 28.11, "mean": 14.13, "std": 3.52 },
    "area_mean": { "min": 143.5, "max": 2501.0, "mean": 654.9, "std": 351.9 }
  },

  "map_regions": {
    "summary": "Benign samples dominate lower-left (neurons 1_0, 2_1, 3_0). Malignant samples cluster in upper-right (neurons 0_3, 0_4, 1_3, 1_4, 2_3, 2_4)."
  }
}
```

---

## 2. Context Builder — Implementation Steps

### Step 1: Load Existing SOM Outputs
Read from `{working_dir}/json/`:
- `clusters.json` → neuron → sample IDs
- `quantization_errors.json` → per-neuron QE
- `extremes.json` → per-sample anomaly reasons
- `pie_data_{col}.json` → per-neuron category counts
- `preprocessing_info.json` → column metadata

Read from `{working_dir}/csv/`:
- `original_input.csv` → original values for computing per-cluster means

### Step 2: Compute Per-Cluster Statistics
For each non-empty neuron:
- Count samples
- Compute mean of each numerical dimension (from original, un-normalized values)
- Get category distribution and dominant category
- Calculate purity (% of dominant category)

### Step 3: Summarize Anomalies
From `extremes.json`:
- Count global vs local outliers
- Rank by severity (number of extreme reasons)
- Keep top-N (configurable, default 10) most extreme samples

### Step 4: Compute Dimension Statistics
From `original_input.csv`:
- Global min, max, mean, std per numerical column
- These give the LLM reference points for interpreting cluster means

### Step 5: Generate Map Region Summary
From cluster positions + category distributions:
- Identify which map regions are dominated by which categories
- Simple spatial description ("left side = X, right side = Y")

### Step 6: Write `llm_context.json`
Combine all computed data into the structured JSON above.

---

## 3. File Locations Summary

```
data/datasets/{DatasetName}/
├── dataset_context.txt              ← User writes this (once per dataset)
├── {source_data}.csv                ← Original dataset
└── results/SOM/
    ├── json/
    │   ├── clusters.json            ← SOM output (exists)
    │   ├── quantization_errors.json ← SOM output (exists)
    │   ├── extremes.json            ← SOM output (exists)
    │   ├── pie_data_{col}.json      ← SOM output (exists)
    │   ├── preprocessing_info.json  ← SOM output (exists)
    │   └── llm_context.json         ← Context Builder generates this (NEW)
    ├── csv/
    │   └── original_input.csv       ← SOM output (exists)
    └── llm/
        ├── report.md                ← LLM generates this (NEW)
        └── prompt_log.json          ← Full prompt saved for traceability (NEW)
```

---

## 4. What Must Be Built

| Component | Input | Output | Priority |
|-----------|-------|--------|----------|
| Dataset context template | — | `dataset_context.txt` template | P1 |
| Context Builder script | SOM JSONs + original CSV | `llm_context.json` | P1 |
| System prompt | — | Hardcoded prompt constraining LLM behavior | P1 |
| LLM adapter (local) | Prompt | Response | P1 |
| LLM adapter (API) | Prompt | Response | P2 |
| Report formatter | LLM response | `report.md` | P2 |
| Conversational mode | User queries + context | Responses | P3 |
